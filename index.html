<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco-City: Tom Edition Fix</title>
    <style>
        :root { --p: #00ff88; --s: #00aaff; --bg: #0a1018; --d: #ff4444; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; color: white; touch-action: none; }

        /* --- AUTH & ADMIN --- */
        #auth-screen {
            position: absolute; width: 100%; height: 100%; z-index: 500;
            background: radial-gradient(circle at center, #112233 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .box { background: rgba(10,25,40,0.95); padding: 30px; border-radius: 20px; border: 2px solid var(--p); text-align: center; width: 85%; max-width: 350px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #334; background: #050a10; color: white; box-sizing: border-box; font-size: 16px; }
        .btn-main { background: var(--p); color: #000; border: none; padding: 18px; width: 100%; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; }

        #admin-panel {
            position: absolute; width: 90%; max-height: 80%; overflow-y: auto; background: #000; 
            border: 2px solid gold; border-radius: 15px; padding: 20px; z-index: 600; display: none;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }
        table { width: 100%; border-collapse: collapse; }
        td, th { border: 1px solid #333; padding: 10px; text-align: left; }

        /* --- HUD & UI --- */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px; display: none;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 15px; border: 1px solid var(--s); z-index: 100;
        }
        .stats { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; margin: 4px 0 10px 0; }
        .bar-fill { height: 100%; border-radius: 4px; transition: 0.5s; }

        #toolbar {
            position: absolute; bottom: 15px; left: 10px; right: 10px; display: none;
            gap: 10px; padding: 10px; background: rgba(0,0,0,0.9);
            border-radius: 15px; overflow-x: auto; z-index: 100;
        }
        .tool {
            min-width: 70px; height: 85px; background: #1a2a3a; border: 2px solid #345;
            border-radius: 12px; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
        }
        .tool.active { border-color: var(--p); background: #003322; }
        .tool-icon { font-size: 24px; }
        .tool-price { font-size: 11px; color: var(--p); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="auth-screen">
        <div class="box">
            <h1 style="color:var(--p);">ECO-CITY</h1>
            <input type="text" id="user" placeholder="Ton PrÃ©nom">
            <input type="password" id="pass" placeholder="Mot de Passe">
            <button class="btn-main" onclick="startAuth()">REJOINDRE LA VILLE</button>
            <p id="err" style="color:var(--d); font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="admin-panel">
        <h2 style="color:gold;">ðŸ“‚ Liste des Maires (Admin)</h2>
        <table id="admin-table">
            <thead><tr><th>PrÃ©nom</th><th>Pass</th></tr></thead>
            <tbody id="admin-body"></tbody>
        </table>
        <button class="btn-main" style="background:gold; margin-top:15px;" onclick="closeAdmin()">FERMER</button>
    </div>

    <div id="hud">
        <div class="stats">
            <span>ðŸ’° <span id="m-val">2000</span>â‚¬</span>
            <span>ðŸ‘¥ <span id="p-val">0</span></span>
            <span style="color:var(--p)" id="u-display"></span>
        </div>
        <div style="font-size:11px;">Ã‰COLOGIE</div>
        <div class="bar-bg"><div id="eco-bar" class="bar-fill" style="background:var(--p); width:50%"></div></div>
        <div style="font-size:11px;">POLLUTION</div>
        <div class="bar-bg"><div id="pol-bar" class="bar-fill" style="background:var(--d); width:10%"></div></div>
    </div>

    <div id="toolbar"></div>
    <div id="game-container"></div>

    <script>
        const TOOLS = [
            { id:'road', icon:'ðŸ›£ï¸', cost:20, pop:0, eco:0, pol:0 },
            { id:'forest', icon:'ðŸŒ²', cost:100, pop:0, eco:15, pol:0 },
            { id:'house', icon:'ðŸ ', cost:200, pop:25, eco:0, pol:2 },
            { id:'apt', icon:'ðŸ¢', cost:800, pop:120, eco:0, pol:8 },
            { id:'factory', icon:'ðŸ­', cost:1200, pop:0, eco:0, pol:30 },
            { id:'solar', icon:'â˜€ï¸', cost:1500, pop:0, eco:35, pol:0 },
            { id:'park', icon:'ðŸŒ³', cost:400, pop:10, eco:20, pol:0 }
        ];

        let state = { money: 2000, pop: 0, eco: 50, pol: 10, buildings: [], user: "", pass: "" };
        let scene, camera, renderer, raycaster, mouse, ghost, grid;
        let selectedId = 'road';
        let cars = [];

        // --- MEMOIRE DU PRENOM ---
        window.onload = () => {
            const lastUser = localStorage.getItem('last_user');
            if(lastUser) document.getElementById('user').value = lastUser;
        };

        function startAuth() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();

            if(u === "2013" && p === "tom") { showAdmin(); return; }
            if(!u || !p) return document.getElementById('err').innerText = "Remplis tout !";

            localStorage.setItem('last_user', u); // On garde son prÃ©nom

            const saved = localStorage.getItem('eco_save_'+u);
            if(saved) {
                const d = JSON.parse(saved);
                if(d.pass !== p) return document.getElementById('err').innerText = "Mauvais mot de passe.";
                state = d;
            } else {
                state.user = u; state.pass = p;
                saveGame();
            }

            document.getElementById('auth-screen').style.display = 'none';
            initGame();
        }

        function initGame() {
            document.getElementById('hud').style.display = 'block';
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('u-display').innerText = state.user;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1018);

            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.OrthographicCamera(-500*aspect, 500*aspect, 500, -500, 1, 3000);
            camera.position.set(500, 500, 500);
            camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-container').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 0.6);
            sun.position.set(200, 500, 100); scene.add(sun);

            grid = new THREE.GridHelper(2000, 40, 0x112233, 0x050a10);
            scene.add(grid);

            ghost = new THREE.Mesh(new THREE.BoxGeometry(45, 2, 45), new THREE.MeshBasicMaterial({color:0x00ff88, transparent:true, opacity:0.3}));
            scene.add(ghost);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Toolbar
            const tb = document.getElementById('toolbar');
            TOOLS.forEach(t => {
                const d = document.createElement('div');
                d.className = `tool ${t.id === selectedId ? 'active' : ''}`;
                d.innerHTML = `<div class="tool-icon">${t.icon}</div><div class="tool-price">${t.cost}â‚¬</div>`;
                d.onclick = () => {
                    selectedId = t.id;
                    document.querySelectorAll('.tool').forEach(el => el.classList.remove('active'));
                    d.classList.add('active');
                };
                tb.appendChild(d);
            });

            // Input
            const onMove = (x, y) => {
                mouse.x = (x / window.innerWidth) * 2 - 1;
                mouse.y = -(y / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(grid);
                if(intersects[0]) {
                    ghost.position.x = Math.round(intersects[0].point.x / 50) * 50;
                    ghost.position.z = Math.round(intersects[0].point.z / 50) * 50;
                }
            };
            window.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
            window.addEventListener('touchstart', e => onMove(e.touches[0].clientX, e.touches[0].clientY));
            window.addEventListener('mousedown', e => {
                if(e.target.closest('#toolbar') || e.target.closest('#hud')) return;
                build(ghost.position.x, ghost.position.z);
            });

            // Re-crÃ©er les bÃ¢timents sauvegardÃ©s
            state.buildings.forEach(b => build(b.x, b.z, b.id, true));
            
            animate();
            setInterval(incomeLoop, 5000);
        }

        function build(x, z, id = null, load = false) {
            const tid = id || selectedId;
            const t = TOOLS.find(i => i.id === tid);
            
            if(!load) {
                if(state.money < t.cost || state.buildings.some(b => b.x===x && b.z===z)) return;
                state.money -= t.cost; state.pop += t.pop;
                state.eco = Math.min(100, state.eco + t.eco);
                state.pol = Math.min(100, state.pol + t.pol);
                state.buildings.push({x, z, id: tid});
                saveGame(); updateHUD();
            }

            const g = new THREE.Group();
            g.position.set(x, 0, z);

            if(tid==='road') {
                const r = new THREE.Mesh(new THREE.BoxGeometry(50,1.2,50), new THREE.MeshLambertMaterial({color:0x222222}));
                const l = new THREE.Mesh(new THREE.BoxGeometry(15,0.5,3), new THREE.MeshBasicMaterial({color:0xffffff}));
                l.position.y=0.7; g.add(r,l);
                if(!load) spawnCar(x, z);
            } else if(tid==='house') {
                const b = new THREE.Mesh(new THREE.BoxGeometry(30,20,30), new THREE.MeshLambertMaterial({color:0xcccccc}));
                const r = new THREE.Mesh(new THREE.ConeGeometry(25,15,4), new THREE.MeshLambertMaterial({color:0xaa2222}));
                b.position.y=10; r.position.y=25; r.rotation.y=Math.PI/4; g.add(b,r);
            } else if(tid==='forest') {
                const t = new THREE.Mesh(new THREE.CylinderGeometry(2,2,10), new THREE.MeshLambertMaterial({color:0x420}));
                const f = new THREE.Mesh(new THREE.ConeGeometry(12,25,6), new THREE.MeshLambertMaterial({color:0x116622}));
                t.position.y=5; f.position.y=20; g.add(t,f);
            } else {
                const h = tid==='apt'?70:tid==='factory'?40:30;
                const b = new THREE.Mesh(new THREE.BoxGeometry(35,h,35), new THREE.MeshLambertMaterial({color:0x667788}));
                b.position.y=h/2; g.add(b);
            }

            scene.add(g);
            g.scale.set(0,0,0);
            let s = 0;
            const anim = setInterval(() => { s += 0.1; g.scale.set(s,s,s); if(s>=1) clearInterval(anim); }, 20);
        }

        function spawnCar(x, z) {
            const c = new THREE.Group();
            const b = new THREE.Mesh(new THREE.BoxGeometry(10,5,18), new THREE.MeshLambertMaterial({color:Math.random()*0xffffff}));
            b.position.y=3; c.add(b);
            c.position.set(x, 0, z); scene.add(c);
            cars.push({m: c, vz: 2, startX: x});
        }

        function animate() {
            requestAnimationFrame(animate);
            cars.forEach(c => {
                const nextZ = c.m.position.z + c.vz;
                const onRoad = state.buildings.some(b => b.id==='road' && b.x===c.startX && Math.abs(b.z - nextZ) < 26);
                if(onRoad) c.m.position.z = nextZ; else c.vz *= -1;
            });
            renderer.render(scene, camera);
        }

        function updateHUD() {
            document.getElementById('m-val').innerText = Math.floor(state.money);
            document.getElementById('p-val').innerText = state.pop;
            document.getElementById('eco-bar').style.width = state.eco + "%";
            document.getElementById('pol-bar').style.width = state.pol + "%";
        }

        function incomeLoop() {
            state.money += (state.pop * 0.2) + (state.eco * 0.5) - (state.pol * 0.3);
            updateHUD(); saveGame();
        }

        function saveGame() { localStorage.setItem('eco_save_'+state.user, JSON.stringify(state)); }

        function showAdmin() {
            const b = document.getElementById('admin-body'); b.innerHTML = "";
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k.startsWith('eco_save_')) {
                    const d = JSON.parse(localStorage.getItem(k));
                    b.innerHTML += `<tr><td>${d.user}</td><td>${d.pass}</td></tr>`;
                }
            }
            document.getElementById('admin-panel').style.display = 'block';
        }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

        window.addEventListener('resize', () => {
            const a = window.innerWidth/window.innerHeight;
            camera.left = -500*a; camera.right = 500*a; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
