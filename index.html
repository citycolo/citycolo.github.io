<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco-City: Tom God Mode</title>
    <style>
        :root { --p: #00ff88; --s: #00aaff; --bg: #050a10; --d: #ff4444; --gold: #ffcc00; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; color: white; touch-action: none; }

        .glass { background: rgba(10, 25, 45, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 15px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #334; background: #050a10; color: white; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-p { background: var(--p); color: #000; }
        .btn-d { background: var(--d); color: white; }

        /* AUTH */
        #auth-screen { position: absolute; width: 100%; height: 100%; z-index: 500; background: radial-gradient(circle, #1a2a3a, #000); display: flex; justify-content: center; align-items: center; }
        .auth-box { padding: 30px; text-align: center; width: 90%; max-width: 360px; border: 2px solid var(--p); }

        /* TOOLTIP & ADMIN */
        #tooltip { position: absolute; pointer-events: none; padding: 10px; background: rgba(0,0,0,0.9); border: 1px solid var(--p); border-radius: 8px; font-size: 13px; display: none; z-index: 1000; }
        #admin-panel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; z-index: 600; display: none; padding: 25px; border: 2px solid var(--gold); }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        
        /* HUD */
        #hud { position: absolute; top: 10px; left: 10px; right: 10px; padding: 15px; display: none; z-index: 100; justify-content: space-between; align-items: center; }
        #toolbar { position: absolute; bottom: 15px; left: 10px; right: 10px; padding: 12px; display: none; z-index: 100; overflow-x: auto; white-space: nowrap; gap: 10px; }
        .tool { display: inline-flex; flex-direction: column; align-items: center; min-width: 70px; height: 85px; justify-content: center; cursor: pointer; border: 2px solid #345; border-radius: 12px; margin-right: 8px; background: rgba(255,255,255,0.05); }
        .tool.active { border-color: var(--p); background: rgba(0,255,136,0.1); }
        
        .bar-bg { width: 100px; height: 6px; background: #222; border-radius: 3px; margin-top: 5px; }
        .bar-fill { height: 100%; border-radius: 3px; transition: 0.3s; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box glass">
            <h1 style="color:var(--p); margin-top:0;">ECO-CITY</h1>
            <input type="text" id="user" placeholder="Ton Pr√©nom">
            <input type="password" id="pass" placeholder="Mot de Passe">
            <button class="btn btn-p" style="width:100%" onclick="startAuth()">ENTRER DANS LA VILLE</button>
            <p id="err" style="color:var(--d); font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="admin-panel" class="glass">
        <h2 style="color:var(--gold);">üìÇ Gestion des Comptes</h2>
        <table id="admin-table">
            <thead><tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>Joueur</th><th>MDP</th></tr></thead>
            <tbody id="admin-body"></tbody>
        </table>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-d" style="flex:1" onclick="deleteSelected()">SUPPRIMER</button>
            <button class="btn btn-p" style="background:#444; color:white;" onclick="closeAdmin()">FERMER</button>
        </div>
    </div>

    <div id="tooltip"></div>

    <div id="hud" class="glass">
        <div>
            üí∞ <b id="m-val">2000</b>‚Ç¨ 
            <div style="font-size:10px; color:var(--p)">Revenu: +<span id="inc-val">0</span>/s</div>
        </div>
        <div style="text-align:center">
            üë• <b id="p-val">0</b>
            <div style="font-size:10px;">POLLUTION</div>
            <div class="bar-bg"><div id="pol-bar" class="bar-fill" style="background:var(--d); width:10%"></div></div>
        </div>
        <div onclick="location.reload()" style="cursor:pointer; font-size:20px;">‚öôÔ∏è</div>
    </div>

    <div id="toolbar" class="glass"></div>
    <div id="game-container"></div>

    <script>
        const TOOLS = [
            { id:'road', icon:'üõ£Ô∏è', cost:20, pop:0, money:0, pol:0 },
            { id:'forest', icon:'üå≤', cost:100, pop:0, money:2, pol:-5 },
            { id:'house', icon:'üè†', cost:250, pop:20, money:5, pol:2 },
            { id:'apt', icon:'üè¢', cost:900, pop:100, money:20, pol:8 },
            { id:'factory', icon:'üè≠', cost:1500, pop:0, money:50, pol:25 },
            { id:'solar', icon:'‚òÄÔ∏è', cost:2000, pop:0, money:60, pol:-10 },
            { id:'hospital', icon:'üè•', cost:3000, pop:50, money:15, pol:0 }
        ];

        let state = { money: 2000, pop: 0, pol: 10, buildings: [], user: "", pass: "", infinite: false };
        let scene, camera, renderer, raycaster, mouse, ghost, grid;
        let selectedId = 'road';
        let buildingObjects = [];

        window.onload = () => {
            const last = localStorage.getItem('last_user');
            if(last) document.getElementById('user').value = last;
        };

        function startAuth() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            
            // ADMIN MODE
            if(u === "2013" && p === "tom") { openAdmin(); return; }
            
            // INFINITE MONEY MODE
            if(u === "teste" && p === "tom") {
                state.money = 999999999;
                state.user = "TRICHEUR";
                state.infinite = true;
                document.getElementById('auth-screen').style.display = 'none';
                initGame();
                return;
            }

            if(!u || !p) return;
            localStorage.setItem('last_user', u);
            const saved = localStorage.getItem('eco_save_' + u);
            if(saved) {
                const d = JSON.parse(saved);
                if(d.pass !== p) { document.getElementById('err').innerText = "MDP Incorrect"; return; }
                state = d;
            } else { state.user = u; state.pass = p; save(); }

            document.getElementById('auth-screen').style.display = 'none';
            initGame();
        }

        function openAdmin() {
            const body = document.getElementById('admin-body');
            body.innerHTML = "";
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k.startsWith('eco_save_')) {
                    const d = JSON.parse(localStorage.getItem(k));
                    body.innerHTML += `<tr><td><input type="checkbox" class="adm-chk" data-user="${d.user}"></td><td>${d.user}</td><td>${d.pass}</td></tr>`;
                }
            }
            document.getElementById('admin-panel').style.display = 'block';
        }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
        function toggleAll(src) { document.querySelectorAll('.adm-chk').forEach(c => c.checked = src.checked); }
        function deleteSelected() {
            document.querySelectorAll('.adm-chk:checked').forEach(c => localStorage.removeItem('eco_save_' + c.dataset.user));
            openAdmin();
        }

        function initGame() {
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('toolbar').style.display = 'block';

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050a10);
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.OrthographicCamera(-500*aspect, 500*aspect, 500, -500, 1, 3000);
            camera.position.set(500, 500, 500); camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-container').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.9));
            grid = new THREE.GridHelper(2000, 40, 0x112233, 0x050a10);
            scene.add(grid);

            ghost = new THREE.Mesh(new THREE.BoxGeometry(45, 2, 45), new THREE.MeshBasicMaterial({color:0x00ff88, transparent:true, opacity:0.3}));
            scene.add(ghost);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const tb = document.getElementById('toolbar');
            TOOLS.forEach(t => {
                const d = document.createElement('div');
                d.className = `tool ${t.id === selectedId ? 'active' : ''}`;
                d.innerHTML = `<span style="font-size:24px">${t.icon}</span><span style="font-size:10px">${t.cost}‚Ç¨</span>`;
                d.onclick = () => { selectedId = t.id; document.querySelectorAll('.tool').forEach(el => el.classList.remove('active')); d.classList.add('active'); };
                tb.appendChild(d);
            });

            window.addEventListener('mousemove', handleInput);
            window.addEventListener('touchstart', (e) => handleInput(e.touches[0]));
            window.addEventListener('mousedown', (e) => {
                if(e.target.closest('.glass')) return;
                build(ghost.position.x, ghost.position.z);
            });

            state.buildings.forEach(b => build(b.x, b.z, b.id, true));
            updateHUD();
            animate();
            setInterval(income, 1000);
        }

        function handleInput(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // HOVER TOOLTIP
            const toolip = document.getElementById('tooltip');
            const intersects = raycaster.intersectObjects(buildingObjects, true);
            if(intersects.length > 0) {
                const s = intersects[0].object.parent.userData.stats;
                if(s) {
                    toolip.style.display = 'block';
                    toolip.style.left = (e.clientX + 15) + 'px';
                    toolip.style.top = (e.clientY + 15) + 'px';
                    toolip.innerHTML = `<b style="color:var(--p)">${s.name}</b><br>üë• Citoyens: ${s.pop}<br>üí∞ Gain: ${s.money}‚Ç¨/s`;
                }
            } else { toolip.style.display = 'none'; }

            const gridHits = raycaster.intersectObject(grid);
            if(gridHits[0]) {
                ghost.position.x = Math.round(gridHits[0].point.x / 50) * 50;
                ghost.position.z = Math.round(gridHits[0].point.z / 50) * 50;
            }
        }

        function build(x, z, id = null, load = false) {
            const tid = id || selectedId;
            const t = TOOLS.find(i => i.id === tid);
            
            if(!load) {
                if(!state.infinite && state.money < t.cost) return;
                if(state.buildings.some(b => b.x===x && b.z===z)) return;
                if(!state.infinite) state.money -= t.cost;
                state.pop += t.pop;
                state.pol = Math.max(0, Math.min(100, state.pol + t.pol));
                state.buildings.push({x, z, id: tid});
                save(); updateHUD();
            }

            const g = new THREE.Group();
            g.position.set(x, 0, z);
            g.userData.stats = { name: tid.toUpperCase(), pop: t.pop, money: t.money };

            const color = tid==='road'?0x333333 : (tid==='forest'?0x116622 : (tid==='factory'?0x555555 : 0x667788));
            const h = tid==='road'?1 : (tid==='apt'?70 : 35);
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(40, h, 40), new THREE.MeshLambertMaterial({color}));
            mesh.position.y = h/2;
            g.add(mesh);

            scene.add(g);
            buildingObjects.push(mesh);
            
            g.scale.set(0,0,0);
            let s = 0;
            const ani = setInterval(() => { s += 0.1; g.scale.set(s,s,s); if(s>=1) clearInterval(ani); }, 20);
        }

        function income() {
            let gain = state.buildings.reduce((sum, b) => sum + TOOLS.find(t => t.id === b.id).money, 0);
            if(!state.infinite) state.money += gain;
            updateHUD();
            if(!state.infinite) save();
        }

        function updateHUD() {
            document.getElementById('m-val').innerText = state.infinite ? "INFINI" : Math.floor(state.money);
            document.getElementById('p-val').innerText = state.pop;
            document.getElementById('pol-bar').style.width = state.pol + "%";
            let gain = state.buildings.reduce((sum, b) => sum + TOOLS.find(t => t.id === b.id).money, 0);
            document.getElementById('inc-val').innerText = gain;
        }

        function save() { if(!state.infinite) localStorage.setItem('eco_save_' + state.user, JSON.stringify(state)); }
        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        
        window.addEventListener('resize', () => {
            const a = window.innerWidth/window.innerHeight;
            camera.left = -500*a; camera.right = 500*a; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
