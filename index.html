<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco-City: Tom Admin Edition</title>
    <style>
        :root { --p: #00ff88; --s: #00aaff; --bg: #050a0f; --d: #ff4444; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; color: white; touch-action: none; }

        /* --- UI AUTH --- */
        #auth-screen {
            position: absolute; width: 100%; height: 100%; z-index: 500;
            background: radial-gradient(circle at center, #112233 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .box { background: rgba(10,20,30,0.95); padding: 25px; border-radius: 20px; border: 1px solid var(--p); text-align: center; width: 85%; max-width: 350px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab { flex:1; padding: 12px; cursor: pointer; background: #1a2a3a; border-radius: 8px; font-size: 13px; border:none; color:white; font-weight: bold;}
        .tab.active { background: var(--p); color: #000; }
        input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: 1px solid #334; background: #0a1520; color: white; box-sizing: border-box; font-size: 16px; }
        .btn-main { background: var(--p); color: #000; border: none; padding: 16px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 16px; }

        /* --- TABLEAU ADMIN (SECRET) --- */
        #admin-panel {
            position: absolute; width: 90%; max-height: 80%; overflow-y: auto; background: #000; 
            border: 2px solid gold; border-radius: 15px; padding: 20px; z-index: 600; display: none;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; font-size: 14px; }
        th { background: #1a1a1a; color: gold; }

        /* --- HUD & TOOLBAR --- */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px; display: none;
            justify-content: space-between; background: rgba(0,0,0,0.85); padding: 12px 15px;
            border-radius: 12px; border-bottom: 2px solid var(--s); z-index: 100; font-size: 14px;
        }
        #toolbar {
            position: absolute; bottom: 10px; left: 10px; right: 10px; display: none;
            gap: 10px; padding: 10px; background: rgba(0,0,0,0.9);
            border-radius: 15px; overflow-x: auto; z-index: 100; white-space: nowrap;
        }
        .tool {
            display: inline-flex; min-width: 65px; height: 80px; background: #16212a; border: 2px solid #345;
            border-radius: 10px; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s;
        }
        .tool.active { border-color: var(--p); background: #002c1a; }
        .tool-icon { font-size: 24px; }
        .tool-price { font-size: 11px; color: var(--p); font-weight: bold; }

        /* --- CINEMATIQUE --- */
        #cine-screen {
            position: absolute; width: 100%; height: 100%; z-index: 400;
            background: black; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #cine-txt { font-size: 20px; text-align: center; max-width: 85%; color: var(--s); }

        #set-btn { position: absolute; top: 70px; right: 15px; font-size: 28px; z-index: 100; display:none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="auth-screen">
        <div class="box">
            <h1 style="color:var(--p); margin:0 0 10px 0;">ECO-CITY</h1>
            <div class="tabs">
                <button id="t-log" class="tab active" onclick="setAuth('login')">Se connecter</button>
                <button id="t-cre" class="tab" onclick="setAuth('create')">Cr√©er compte</button>
            </div>
            <input type="text" id="user" placeholder="Nom du Maire">
            <input type="password" id="pass" placeholder="Mot de passe">
            <button class="btn-main" onclick="startAuth()">D√âMARRER</button>
            <p id="err" style="color:var(--d); font-size:12px; height:15px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="admin-panel">
        <h2 style="color:gold; margin-top:0;">üìÇ Base de donn√©es Joueurs</h2>
        <table id="admin-table">
            <thead><tr><th>Maire</th><th>Mot de passe</th></tr></thead>
            <tbody id="admin-body"></tbody>
        </table>
        <button class="btn-main" style="background:gold;" onclick="closeAdmin()">FERMER LA BASE</button>
    </div>

    <div id="cine-screen">
        <div id="cine-txt"></div>
        <button id="skip" class="btn-main" style="width:200px; display:none; margin-top:40px;" onclick="launchGame()">ENTRER</button>
    </div>

    <div id="hud">
        <span>üí∞ <b id="m-val">2000</b></span>
        <span>üë• <b id="p-val">0</b></span>
        <span style="color:var(--s)">üèôÔ∏è <b id="u-val"></b></span>
    </div>
    <div id="set-btn" onclick="toggleSet()">‚öôÔ∏è</div>
    <div id="toolbar"></div>
    <div id="game"></div>

    <script>
        const TOOLS = [
            { id:'road', icon:'üõ£Ô∏è', cost:20, pop:0 },
            { id:'forest', icon:'üå≤', cost:80, pop:0 },
            { id:'house', icon:'üè†', cost:150, pop:20 },
            { id:'apt', icon:'üè¢', cost:600, pop:90 },
            { id:'sky', icon:'üèôÔ∏è', cost:2500, pop:400 },
            { id:'factory', icon:'üè≠', cost:1000, pop:0 },
            { id:'solar', icon:'‚òÄÔ∏è', cost:1200, pop:0 },
            { id:'wind', icon:'üå¨Ô∏è', cost:1500, pop:0 },
            { id:'nuclear', icon:'‚ò¢Ô∏è', cost:6000, pop:0 },
            { id:'shop', icon:'üõí', cost:500, pop:15 },
            { id:'school', icon:'üè´', cost:800, pop:10 },
            { id:'hospital', icon:'üè•', cost:2000, pop:30 },
            { id:'police', icon:'üöì', cost:1200, pop:0 },
            { id:'park', icon:'üå≥', cost:400, pop:0 },
            { id:'fountain', icon:'‚õ≤', cost:300, pop:0 }
        ];

        let state = { money: 2000, pop: 0, buildings: [], user: "" };
        let mode = 'login';
        let audioCtx, musicGain, isMusic = false;

        // --- GESTION ADMIN (2013 + tom) ---
        function openAdmin() {
            const body = document.getElementById('admin-body');
            body.innerHTML = "";
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eco_')) {
                    const data = JSON.parse(localStorage.getItem(key));
                    const row = `<tr><td>${key.replace('eco_', '')}</td><td>${data.pass}</td></tr>`;
                    body.innerHTML += row;
                }
            }
            document.getElementById('admin-panel').style.display = 'block';
        }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

        // --- AUTH & MUSIQUE ---
        function setAuth(m) {
            mode = m;
            document.getElementById('t-log').className = 'tab ' + (m==='login'?'active':'');
            document.getElementById('t-cre').className = 'tab ' + (m==='create'?'active':'');
        }

        function startAuth() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();

            // V√©rification Admin
            if(u === "2013" && p === "tom") {
                openAdmin();
                return;
            }

            if(!u || !p) return document.getElementById('err').innerText = "Veuillez remplir les champs.";

            const data = localStorage.getItem('eco_'+u);
            if(mode === 'create') {
                if(data) return document.getElementById('err').innerText = "Ce maire existe d√©j√†.";
                localStorage.setItem('eco_'+u, JSON.stringify({pass:p, state}));
            } else {
                if(!data) return document.getElementById('err').innerText = "Maire introuvable.";
                const d = JSON.parse(data);
                if(d.pass !== p) return document.getElementById('err').innerText = "Mot de passe faux.";
                state = d.state;
            }
            state.user = u;
            document.getElementById('auth-screen').style.display = 'none';
            runCinematic();
        }

        function runCinematic() {
            const screen = document.getElementById('cine-screen');
            const txt = document.getElementById('cine-txt');
            screen.style.display = 'flex';
            const lines = ["Connexion crypt√©e...", "Bienvenue Maire " + state.user, "Chargement de la ville...", "Pr√™t √† construire ?"];
            let i = 0;
            const next = () => {
                if(i < lines.length) {
                    txt.innerText = lines[i++];
                    setTimeout(next, 1500);
                } else { document.getElementById('skip').style.display = 'block'; }
            };
            next();
        }

        // --- JEU & 3D ---
        let scene, camera, renderer, raycaster, mouse, ghost, grid;
        let selectedId = 'road';
        let carList = [];

        function launchGame() {
            document.getElementById('cine-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('set-btn').style.display = 'block';
            document.getElementById('u-val').innerText = state.user;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050a0f);
            const a = window.innerWidth/window.innerHeight;
            camera = new THREE.OrthographicCamera(-400*a, 400*a, 400, -400, 1, 2000);
            camera.position.set(500, 500, 500); camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('game').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(200, 400, 100); scene.add(sun);

            grid = new THREE.GridHelper(2000, 40, 0x112233, 0x081018); scene.add(grid);
            ghost = new THREE.Mesh(new THREE.BoxGeometry(48, 2, 48), new THREE.MeshBasicMaterial({color:0x00ff88, transparent:true, opacity:0.3}));
            scene.add(ghost);

            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            const tb = document.getElementById('toolbar');
            TOOLS.forEach(t => {
                const d = document.createElement('div');
                d.className = `tool ${t.id === selectedId ? 'active' : ''}`;
                d.innerHTML = `<div class="tool-icon">${t.icon}</div><div class="tool-price">${t.cost}‚Ç¨</div>`;
                d.onclick = () => {
                    selectedId = t.id;
                    document.querySelectorAll('.tool').forEach(el => el.classList.remove('active'));
                    d.classList.add('active');
                };
                tb.appendChild(d);
            });

            const onMove = (x, y) => {
                mouse.x = (x / window.innerWidth) * 2 - 1;
                mouse.y = -(y / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const it = raycaster.intersectObject(grid);
                if(it[0]) {
                    ghost.position.x = Math.round(it[0].point.x / 50) * 50;
                    ghost.position.z = Math.round(it[0].point.z / 50) * 50;
                }
            };

            window.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
            window.addEventListener('touchstart', e => onMove(e.touches[0].clientX, e.touches[0].clientY));
            window.addEventListener('mousedown', e => {
                if(e.target.closest('#toolbar') || e.target.closest('#hud') || e.target.closest('#admin-panel')) return;
                build(ghost.position.x, ghost.position.z);
            });

            state.buildings.forEach(b => build(b.x, b.z, b.id, true));
            initMusic(); animate(); setInterval(() => { state.money += (state.pop * 0.2) + 10; updateHUD(); }, 4000);
        }

        function build(x, z, id = null, load = false) {
            const tid = id || selectedId;
            const tool = TOOLS.find(t => t.id === tid);
            if(!load && (state.money < tool.cost || state.buildings.some(b => b.x===x && b.z===z))) return;

            if(!load) { 
                state.money -= tool.cost; state.pop += tool.pop; state.buildings.push({x, z, id: tid}); 
                updateHUD(); localStorage.setItem('eco_'+state.user, JSON.stringify({pass:"save", state}));
            }

            const g = new THREE.Group(); g.position.set(x, 0, z);
            if(tid==='road') {
                const r = new THREE.Mesh(new THREE.BoxGeometry(50,1,50), new THREE.MeshLambertMaterial({color:0x222222}));
                const l = new THREE.Mesh(new THREE.BoxGeometry(15,0.5,2), new THREE.MeshBasicMaterial({color:0xffffff}));
                l.position.y=0.7; g.add(r,l);
                if(!load) spawnCar(x, z);
            } else if(tid==='forest' || tid==='park') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(2,2,10), new THREE.MeshLambertMaterial({color:0x420}));
                const leaf = new THREE.Mesh(new THREE.ConeGeometry(12,20,8), new THREE.MeshLambertMaterial({color:0x152}));
                leaf.position.y=15; g.add(trunk, leaf);
            } else {
                const h = tid==='sky'?140:tid==='apt'?60:30;
                const b = new THREE.Mesh(new THREE.BoxGeometry(35,h,35), new THREE.MeshLambertMaterial({color:0x667788}));
                b.position.y=h/2; g.add(b);
            }
            scene.add(g);
        }

        function spawnCar(x, z) {
            const car = new THREE.Group();
            const b = new THREE.Mesh(new THREE.BoxGeometry(10,5,16), new THREE.MeshLambertMaterial({color:Math.random()*0xffffff}));
            b.position.y=3; car.add(b);
            car.position.set(x, 0, z); scene.add(car);
            carList.push({m: car, vz: 1.5});
        }

        function animate() {
            requestAnimationFrame(animate);
            carList.forEach(c => {
                const gX = Math.round(c.m.position.x / 50) * 50;
                const gZ = Math.round((c.m.position.z + c.vz) / 50) * 50;
                if(state.buildings.some(b => b.id==='road' && b.x===gX && b.z===gZ)) c.m.position.z += c.vz;
                else c.vz *= -1;
            });
            renderer.render(scene, camera);
        }

        function updateHUD() {
            document.getElementById('m-val').innerText = Math.floor(state.money);
            document.getElementById('p-val').innerText = state.pop;
        }

        function initMusic() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            musicGain = audioCtx.createGain(); musicGain.connect(audioCtx.destination);
            musicGain.gain.value = 0.2; isMusic = true;
            const notes = [261, 329, 392, 523, 440, 349];
            let i = 0;
            setInterval(() => {
                if(!isMusic) return;
                const osc = audioCtx.createOscillator();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(notes[i%notes.length], audioCtx.currentTime);
                const g = audioCtx.createGain();
                g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
                osc.connect(g); g.connect(musicGain);
                osc.start(); osc.stop(audioCtx.currentTime + 2);
                i++;
            }, 1000);
        }

        window.addEventListener('resize', () => {
            const a = window.innerWidth/window.innerHeight;
            camera.left = -400*a; camera.right = 400*a; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
