<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco-City: Tom Ultimate</title>
    <style>
        :root { --p: #00ff88; --s: #00aaff; --bg: #050a0f; --d: #ff4444; --w: #ffffff; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; color: var(--w); touch-action: none; }

        /* --- AUTH & ADMIN --- */
        #auth-screen {
            position: absolute; width: 100%; height: 100%; z-index: 500;
            background: radial-gradient(circle at center, #112233 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .box { background: rgba(10,25,40,0.98); padding: 30px; border-radius: 25px; border: 2px solid var(--p); text-align: center; width: 85%; max-width: 380px; box-shadow: 0 0 50px rgba(0,255,136,0.2); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex:1; padding: 12px; cursor: pointer; background: #1a2a3a; border-radius: 10px; border:none; color:white; font-weight: bold; transition: 0.3s; }
        .tab.active { background: var(--p); color: #000; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #334; background: #0a1520; color: white; box-sizing: border-box; font-size: 16px; }
        .btn-main { background: var(--p); color: #000; border: none; padding: 18px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.95); }

        #admin-panel {
            position: absolute; width: 90%; max-height: 80%; overflow-y: auto; background: #0a0a0a; 
            border: 3px solid gold; border-radius: 20px; padding: 20px; z-index: 600; display: none;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }
        table { width: 100%; border-collapse: collapse; color: white; }
        th, td { border: 1px solid #333; padding: 12px; text-align: left; }

        /* --- HUD --- */
        #hud {
            position: absolute; top: 15px; left: 10px; right: 10px; display: none;
            flex-direction: column; gap: 10px; z-index: 100; pointer-events: none;
        }
        .stats-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 15px; border: 1px solid var(--s); }
        .bar-container { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }

        #toolbar {
            position: absolute; bottom: 20px; left: 10px; right: 10px; display: none;
            gap: 12px; padding: 15px; background: rgba(0,0,0,0.85);
            border-radius: 20px; overflow-x: auto; z-index: 100; 
        }
        .tool {
            display: inline-flex; min-width: 75px; height: 90px; background: #1a2a3a; border: 2px solid #345;
            border-radius: 15px; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        .tool.active { border-color: var(--p); background: #003322; transform: translateY(-5px); }
        .tool-icon { font-size: 28px; }
        .tool-price { font-size: 12px; color: var(--p); font-weight: bold; }

        /* --- CINEMATIQUE --- */
        #cine-screen {
            position: absolute; width: 100%; height: 100%; z-index: 400;
            background: black; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #cine-txt { font-size: 24px; text-align: center; max-width: 80%; color: var(--p); text-shadow: 0 0 15px var(--p); }

        #set-btn { position: absolute; top: 110px; right: 15px; font-size: 30px; z-index: 100; display:none; filter: drop-shadow(0 0 5px black); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="auth-screen">
        <div class="box">
            <h1 style="color:var(--p); margin:0 0 10px 0; letter-spacing: 2px;">ECO-CITY</h1>
            <div class="tabs">
                <button id="t-log" class="tab active" onclick="setAuth('login')">LOGIN</button>
                <button id="t-cre" class="tab" onclick="setAuth('create')">CR√âER</button>
            </div>
            <input type="text" id="user" placeholder="Nom du Maire">
            <input type="password" id="pass" placeholder="Mot de passe">
            <button class="btn-main" onclick="startAuth()">ENTRER DANS LA VILLE</button>
            <p id="err" style="color:var(--d); font-size:13px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="admin-panel">
        <h2 style="color:gold;">üìÇ Base de donn√©es de Tom</h2>
        <table id="admin-table">
            <thead><tr><th>Joueur</th><th>MDP</th></tr></thead>
            <tbody id="admin-body"></tbody>
        </table>
        <button class="btn-main" style="background:gold; margin-top:20px;" onclick="closeAdmin()">QUITTER</button>
    </div>

    <div id="cine-screen">
        <div id="cine-txt"></div>
        <button id="skip" class="btn-main" style="width:220px; display:none; margin-top:40px;" onclick="launchGame()">D√âMARRER</button>
    </div>

    <div id="hud">
        <div class="stats-row">
            <span>üí∞ <b id="m-val">2000</b>‚Ç¨</span>
            <span>üë• <b id="p-val">0</b></span>
            <span style="color:var(--p)">üë§ <b id="u-val"></b></span>
        </div>
        <div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 12px; border: 1px solid #333;">
            <div style="display:flex; justify-content:space-between; font-size:12px;">
                <span>√âCOLOGIE</span>
                <span id="eco-val">50%</span>
            </div>
            <div class="bar-container"><div id="eco-bar" class="bar-fill" style="background:var(--p); width:50%"></div></div>
            
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:8px;">
                <span>POLLUTION</span>
                <span id="pol-val">10%</span>
            </div>
            <div class="bar-container"><div id="pol-bar" class="bar-fill" style="background:var(--d); width:10%"></div></div>
        </div>
    </div>

    <div id="set-btn" onclick="alert('Cr√©ateur: Tom\nVersion: 5.0 Ultimate')">‚öôÔ∏è</div>
    <div id="toolbar"></div>
    <div id="game"></div>

    <script>
        const TOOLS = [
            { id:'road', icon:'üõ£Ô∏è', cost:20, pop:0, eco:0, pol:0 },
            { id:'forest', icon:'üå≤', cost:100, pop:0, eco:15, pol:0 },
            { id:'house', icon:'üè†', cost:200, pop:20, eco:0, pol:1 },
            { id:'apt', icon:'üè¢', cost:800, pop:100, eco:0, pol:5 },
            { id:'factory', icon:'üè≠', cost:1200, pop:0, eco:0, pol:25 },
            { id:'solar', icon:'‚òÄÔ∏è', cost:1500, pop:0, eco:30, pol:0 },
            { id:'park', icon:'üå≥', cost:400, pop:5, eco:20, pol:0 },
            { id:'nuclear', icon:'‚ò¢Ô∏è', cost:8000, pop:0, eco:0, pol:50 },
            { id:'hospital', icon:'üè•', cost:2500, pop:50, eco:5, pol:0 },
            { id:'school', icon:'üè´', cost:1000, pop:20, eco:5, pol:0 }
        ];

        let state = { money: 2000, pop: 0, eco: 50, pol: 10, buildings: [], user: "", pass: "" };
        let mode = 'login';
        let audioCtx, musicGain;

        // --- AUTH & ADMIN ---
        function setAuth(m) {
            mode = m;
            document.getElementById('t-log').className = 'tab ' + (m==='login'?'active':'');
            document.getElementById('t-cre').className = 'tab ' + (m==='create'?'active':'');
        }

        function startAuth() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();

            if(u === "2013" && p === "tom") { openAdmin(); return; }
            if(!u || !p) return document.getElementById('err').innerText = "Remplissez les champs !";

            const data = localStorage.getItem('eco_'+u);
            if(mode === 'create') {
                if(data) return document.getElementById('err').innerText = "Ce maire existe d√©j√†.";
                state.user = u; state.pass = p;
                localStorage.setItem('eco_'+u, JSON.stringify(state));
            } else {
                if(!data) return document.getElementById('err').innerText = "Maire inconnu.";
                const d = JSON.parse(data);
                if(d.pass !== p) return document.getElementById('err').innerText = "Mot de passe incorrect.";
                state = d;
            }
            document.getElementById('auth-screen').style.display = 'none';
            runCinematic();
        }

        function openAdmin() {
            const body = document.getElementById('admin-body');
            body.innerHTML = "";
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eco_')) {
                    const d = JSON.parse(localStorage.getItem(key));
                    body.innerHTML += `<tr><td>${d.user}</td><td>${d.pass}</td></tr>`;
                }
            }
            document.getElementById('admin-panel').style.display = 'block';
        }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

        function runCinematic() {
            const screen = document.getElementById('cine-screen');
            const txt = document.getElementById('cine-txt');
            screen.style.display = 'flex';
            const lines = ["Initialisation...", "Bonjour Maire " + state.user, "Analyse environnementale...", "Syst√®me pr√™t."];
            let i = 0;
            const next = () => {
                if(i < lines.length) { txt.innerText = lines[i++]; setTimeout(next, 1200); }
                else { document.getElementById('skip').style.display = 'block'; }
            };
            next();
        }

        // --- MOTEUR 3D ---
        let scene, camera, renderer, raycaster, mouse, ghost, grid;
        let selectedId = 'road';
        let cars = [];

        function launchGame() {
            document.getElementById('cine-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('set-btn').style.display = 'block';
            document.getElementById('u-val').innerText = state.user;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1018);
            
            const a = window.innerWidth / window.innerHeight;
            camera = new THREE.OrthographicCamera(-450*a, 450*a, 450, -450, 1, 2000);
            camera.position.set(500, 500, 500); camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('game').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(200, 500, 100); scene.add(sun);

            grid = new THREE.GridHelper(2000, 40, 0x112233, 0x050a10);
            scene.add(grid);

            ghost = new THREE.Mesh(new THREE.BoxGeometry(46, 2, 46), new THREE.MeshBasicMaterial({color:varToHex('--p'), transparent:true, opacity:0.4}));
            scene.add(ghost);

            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            const tb = document.getElementById('toolbar');
            TOOLS.forEach(t => {
                const d = document.createElement('div');
                d.className = `tool ${t.id === selectedId ? 'active' : ''}`;
                d.innerHTML = `<div class="tool-icon">${t.icon}</div><div class="tool-price">${t.cost}‚Ç¨</div>`;
                d.onclick = () => {
                    selectedId = t.id;
                    document.querySelectorAll('.tool').forEach(el => el.classList.remove('active'));
                    d.classList.add('active');
                };
                tb.appendChild(d);
            });

            const handleIn = (x, y) => {
                mouse.x = (x / window.innerWidth) * 2 - 1;
                mouse.y = -(y / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const it = raycaster.intersectObject(grid);
                if(it[0]) {
                    ghost.position.x = Math.round(it[0].point.x / 50) * 50;
                    ghost.position.z = Math.round(it[0].point.z / 50) * 50;
                }
            };

            window.addEventListener('mousemove', e => handleIn(e.clientX, e.clientY));
            window.addEventListener('touchstart', e => handleIn(e.touches[0].clientX, e.touches[0].clientY));
            window.addEventListener('mousedown', e => {
                if(e.target.closest('#toolbar') || e.target.closest('#hud')) return;
                build(ghost.position.x, ghost.position.z);
            });

            state.buildings.forEach(b => build(b.x, b.z, b.id, true));
            updateHUD();
            animate();
            initMusic();
            setInterval(gameLoop, 5000);
        }

        function build(x, z, id = null, load = false) {
            const tid = id || selectedId;
            const t = TOOLS.find(i => i.id === tid);
            if(!load && (state.money < t.cost || state.buildings.some(b => b.x===x && b.z===z))) return;

            if(!load) {
                state.money -= t.cost; state.pop += t.pop; 
                state.eco = Math.min(100, state.eco + t.eco);
                state.pol = Math.min(100, state.pol + t.pol);
                state.buildings.push({x, z, id: tid});
                updateHUD(); save();
            }

            const g = new THREE.Group(); g.position.set(x, 0, z);
            
            // MOD√àLES D√âTAILL√âS
            if(tid==='road') {
                const r = new THREE.Mesh(new THREE.BoxGeometry(50,1,50), new THREE.MeshLambertMaterial({color:0x222222}));
                const l = new THREE.Mesh(new THREE.BoxGeometry(15,0.6,3), new THREE.MeshBasicMaterial({color:0xffffff}));
                l.position.y=0.5; g.add(r,l);
                if(!load) spawnCar(x, z);
            } else if(tid==='house') {
                const b = new THREE.Mesh(new THREE.BoxGeometry(30,20,30), new THREE.MeshLambertMaterial({color:0xdddddd}));
                const r = new THREE.Mesh(new THREE.ConeGeometry(25,15,4), new THREE.MeshLambertMaterial({color:0xaa2222}));
                b.position.y=10; r.position.y=25; r.rotation.y=Math.PI/4; g.add(b,r);
            } else if(tid==='factory') {
                const b = new THREE.Mesh(new THREE.BoxGeometry(40,20,30), new THREE.MeshLambertMaterial({color:0x555555}));
                const c = new THREE.Mesh(new THREE.CylinderGeometry(5,5,40), new THREE.MeshLambertMaterial({color:0x333333}));
                b.position.y=10; c.position.set(10,20,0); g.add(b,c);
            } else if(tid==='forest') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(2,2,10), new THREE.MeshLambertMaterial({color:0x442200}));
                const leaf = new THREE.Mesh(new THREE.ConeGeometry(12,25,6), new THREE.MeshLambertMaterial({color:0x116622}));
                trunk.position.y=5; leaf.position.y=20; g.add(trunk, leaf);
            } else {
                const h = tid==='sky'?150:tid==='apt'?70:40;
                const b = new THREE.Mesh(new THREE.BoxGeometry(35,h,35), new THREE.MeshLambertMaterial({color:0x667788}));
                b.position.y=h/2; g.add(b);
            }

            scene.add(g);
            // Animation Pop
            g.scale.set(0,0,0);
            let s = 0;
            const anim = setInterval(() => { 
                s += 0.15; 
                let bounce = s > 1 ? 1 : s;
                g.scale.set(bounce, bounce, bounce); 
                if(s >= 1) clearInterval(anim); 
            }, 30);
        }

        function spawnCar(x, z) {
            const car = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(12,6,20), new THREE.MeshLambertMaterial({color:Math.random()*0xffffff}));
            body.position.y=4; car.add(body);
            car.position.set(x, 0, z); scene.add(car);
            cars.push({m: car, vz: 2, startX: x});
        }

        function animate() {
            requestAnimationFrame(animate);
            cars.forEach(c => {
                const nextZ = c.m.position.z + c.vz;
                const hasRoad = state.buildings.some(b => b.id==='road' && b.x===c.startX && Math.abs(b.z - nextZ) < 25);
                if(hasRoad) c.m.position.z = nextZ; else c.vz *= -1;
            });
            renderer.render(scene, camera);
        }

        function updateHUD() {
            document.getElementById('m-val').innerText = Math.floor(state.money);
            document.getElementById('p-val').innerText = state.pop;
            document.getElementById('eco-val').innerText = state.eco + "%";
            document.getElementById('pol-val').innerText = state.pol + "%";
            document.getElementById('eco-bar').style.width = state.eco + "%";
            document.getElementById('pol-bar').style.width = state.pol + "%";
            
            // Changement de couleur du ciel selon pollution
            const pRatio = state.pol / 100;
            scene.background.setHSL(0.6, 0.5, 0.1 - (pRatio*0.05));
        }

        function gameLoop() {
            state.money += (state.pop * 0.2) + (state.eco * 0.5) - (state.pol * 0.3);
            if(state.money < 0) state.money = 0;
            updateHUD();
            save();
        }

        function save() { localStorage.setItem('eco_'+state.user, JSON.stringify(state)); }

        function initMusic() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            musicGain = audioCtx.createGain(); musicGain.connect(audioCtx.destination);
            musicGain.gain.value = 0.15;
            const notes = [261, 293, 329, 349, 392, 440];
            let i = 0;
            setInterval(() => {
                const osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(notes[i%notes.length], audioCtx.currentTime);
                const g = audioCtx.createGain();
                g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 3);
                osc.connect(g); g.connect(musicGain);
                osc.start(); osc.stop(audioCtx.currentTime + 3);
                i++;
            }, 1200);
        }

        function varToHex(v) { return 0x00ff88; }
        window.addEventListener('resize', () => {
            const a = window.innerWidth/window.innerHeight;
            camera.left = -450*a; camera.right = 450*a; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
